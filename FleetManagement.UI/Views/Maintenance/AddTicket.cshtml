
 
@using FleetManagement.UI.Models.Dto
@model MaintenanceTicket



@{
    ViewBag.Title = "Add Maintenance Ticket";
}
<div class="container mt-4">
    <h2>Add Maintenance Ticket</h2>

    <!-- Driver details update form (GET to AddTicket with query parameters) -->
    <form method="get" asp-action="AddTicket" class="row g-3 mb-3">
        <div class="col-md-6">
            <label class="form-label">Driver Name</label>
            <input type="text" name="driverName" class="form-control" value="@Model.DriverName" required />
        </div>
        <div class="col-md-6">
            <label class="form-label">Car License</label>
            <input type="text" name="carLicense" class="form-control" value="@Model.CarLicense" required />
        </div>
        <div class="col-md-12">
            <button type="submit" class="btn btn-secondary">Update Driver Info</button>
        </div>
    </form>

    <!-- Form for adding maintenance items -->
    <form id="addItemForm">
        <div class="row">
            <div class="col-md-4">
                <label class="form-label">Parts</label>
                <select class="form-select" id="Part" name="Part">
                    @foreach (var part in ViewBag.Parts)
                    {
                        <option value="@part">@part</option>
                    }
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">Quantity</label>
                <input type="number" id="Quantity" name="Quantity" class="form-control" min="1" required>
            </div>
            <div class="col-md-4">
                <label class="form-label">Unit Price (₦)</label>
                <input type="number" id="UnitPrice" name="UnitPrice" class="form-control" min="0" step="0.01" required>
            </div>
        </div>
        <div class="mt-3">
            <button type="submit" class="btn btn-success">Add Item</button>
            <a asp-action="SendRequest" class="btn btn-primary">Send Request</a>
        </div>
    </form>

    <hr>

    <h4>Current Ticket: @Model.TicketNumber</h4>
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Part</th>
                <th>Quantity</th>
                <th>Unit Price</th>
                <th>Total Price</th>
            </tr>
        </thead>
        <tbody id="ticketItems">
            @foreach (var item in Model.Items)
            {
                <tr>
                    <td>@item.Part</td>
                    <td>@item.Quantity</td>
                    <td>₦@item.UnitPrice.ToString("N2")</td>
                    <td>₦@item.TotalPrice.ToString("N2")</td>
                </tr>
            }
        </tbody>
    </table>
</div>

<script>
    document.getElementById("addItemForm").addEventListener("submit", function(event) {
        event.preventDefault();

        let formData = new FormData(this);

        fetch("@Url.Action("AddTicketItem", "Maintenance")", {
            method: "POST",
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                let newRow = `
                    <tr>
                        <td>${data.part}</td>
                        <td>${data.quantity}</td>
                        <td>₦${data.unitPrice}</td>
                        <td>₦${data.totalPrice}</td>
                    </tr>`;
                document.getElementById("ticketItems").innerHTML += newRow;
                document.getElementById("Quantity").value = "";
                document.getElementById("UnitPrice").value = "";
            } else {
                alert("Failed to add item.");
            }
        })
        .catch(error => console.error("Error:", error));
    });
</script>















@* <div class="container mt-4">
    <h2>Add Maintenance Ticket</h2>

    <form id="addTicketForm">
        <div class="col-md-6">
            <div class="mb-3 has-success">
                <label class="form-label">Parts</label>
                <select class="form-select" id="Part" name="Part">
                    @foreach (var part in ViewBag.Parts)
                    {
                        <option value="@part">@part</option>
                    }
                </select>
            </div>
        </div>
        <div class="col-md-6">
            <div class="mb-3">
                <label class="form-label">Quantity</label>
                <input type="number" id="Quantity" name="Quantity" class="form-control" min="1" required>
            </div>
        </div>
        <div class="col-md-6">
            <div class="mb-3">
                <label class="form-label">Unit Price (₦)</label>
                <input type="number" id="UnitPrice" name="UnitPrice" class="form-control" min="0" step="0.01" required>
            </div>
        </div>
        <div class="d-md-flex align-items-center">
            <div class="mt-3 mt-md-0 ms-auto">
                <button type="submit" class="btn btn-success hstack gap-6">
                    <i class="fas fa-plus fs-4"></i>
                    Add
                </button>
            </div>
            <div class="mt-3 mt-md-0 ms-auto">
                <a asp-action="SendRequest" class="btn btn-primary hstack gap-6">
                    <i class="fas fa-paper-plane fs-4"></i>
                    Send Request
                </a>
            </div>
        </div>
    </form>

    <hr>

    <h4>Current Ticket: @Model.TicketNumber</h4>
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Part</th>
                <th>Quantity</th>
                <th>Unit Price</th>
                <th>Total Price</th>
            </tr>
        </thead>
        <tbody id="ticketItems">
            @foreach (var item in Model.Items)
            {
                <tr>
                    <td>@item.Part</td>
                    <td>@item.Quantity</td>
                    <td>₦@item.UnitPrice.ToString("N2")</td>
                    <td>₦@item.TotalPrice.ToString("N2")</td>
                </tr>
            }
        </tbody>
    </table>
</div>

<script>
    document.getElementById("addTicketForm").addEventListener("submit", function(event) {
        event.preventDefault(); // Prevent page reload

        let formData = new FormData(this);

        fetch("@Url.Action("AddTicketItem", "Maintenance")", {
            method: "POST",
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            console.log(data); // Debug response in console

            if (data.success) {
                let newRow = `
                    <tr>
                        <td>${data.part}</td>
                        <td>${data.quantity}</td>
                        <td>₦${data.unitPrice}</td>
                        <td>₦${data.totalPrice}</td>
                    </tr>`;
                document.getElementById("ticketItems").innerHTML += newRow;

                // Reset form fields
                document.getElementById("Quantity").value = "";
                document.getElementById("UnitPrice").value = "";
            } else {
                alert("Failed to add item.");
            }
        })
        .catch(error => console.error("Error:", error));
    });
</script>


 *@